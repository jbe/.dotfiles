#!/usr/bin/env ruby

def nasty_require(*gems)
  gems.each do |gem|
    begin
      require gem
    rescue LoadError
      puts " > installing #{gem}"
      system "gem install #{gem}"
      system $0, *ARGV
      exit
    end
  end
end

nasty_require(*%w(git-up))

def megasync(hardcore, *paths)
  paths.each do |dir|
    if File.directory? dir
      puts " > #{dir}"
      Dir.chdir(dir)
      GitUp.new.run([])
      if hardcore
        system "cd #{dir} && git add -A && git commit"
        system "cd #{dir} && git push"
      end
    else
      puts "Not a directory: #{dir}"
      exit
    end
  end
end

def maintain
  megasync(false, *%w(.vim .dotfiles me).map do |p|
    File.join(Dir.home, p)
  end)

  %w(repos).each do |f|
    megasync(false, *Dir[File.join Dir.home, f,'*/'])
  end
end

if ARGV.empty?
  maintain
else
  megasync(ARGV.map {|p| File.join(Dir.pwd, p) })
end
