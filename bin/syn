#!/usr/bin/env ruby

def nasty_require(*gems)
  gems.each do |gem|
    begin
      require gem
    rescue LoadError
      puts " > installing #{gem}"
      system "gem install #{gem}"
      system $0, *ARGV
      exit
    end
  end
end

nasty_require(*%w(git-up))

def megasync(hardcore, *paths)
  paths.each do |dir|
    if File.directory? dir
      puts " > #{dir}"
      Dir.chdir(dir)
      GitUp.new.run([])
      if hardcore
        system "sh -c 'cd #{dir} && git add -A && git commit && git push'"
      end
    else
      puts "Not a directory: #{dir}"
    end
  end
end

def megasync_dir(dir)
  megasync(false, *Dir[File.join dir,'*/'])
end

if ARGV.empty?
  megasync(true, *%w(.vim .dotfiles .priv me).map do |p|
    File.join(Dir.home, p)
  end)
else
  megasync_dir(ARGV.map {|d| File.expand_path(d) })
end
